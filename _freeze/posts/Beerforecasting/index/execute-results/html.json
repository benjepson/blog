{
  "hash": "599e66c81870691d4ed354dcd51332cb",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Australia Production Forecasting\"\ndescription: \"SPC applied to forecasting & monitoring\"\nauthor: \"Ben Jepson\"\ndate: \"\"\nformat:\n  html:\n    toc: true\n    code-fold: true\ncategories: [intuitive analysis, forecasting, prediction, SPC]\n---\n\n\n\n\n\n\n## Introduction\n\nI'd like to walk through an example of using SPC (statistical process control) to understand a non-manufacturing dataset. Control charts are useful for any process that happens over time. For this project I'll use the aus_production dataset from the fpp3 package. It contains quarterly data from 1951 - 2010 of production amounts of beer, tobacco, bricks, cement, electricity, and gas. \n\nRather than looking at the entire dataset, I'd like to walk through it as if this was a new process we're tracking, and starting at the beginning. I'll be using XmR aka ImR control charts, the chart for individual values. The value is plotted with  lines marking the average, and upper/lower limits. The limits are known as 3 sigma limits, and we can use them as a clue to see if the process is changing over time and whether it is predictable. The limits are based on the differences between successive values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#import aus_production dataset from fpp3\naus <- data.frame(aus_production)\n\n#original variable Quarter contains both year YYYY and quarter, want to split for my purposes here - probably will want to separate by quarter\n#the year YYYY: as \"year\"\naus$year = as.integer(sapply(strsplit(as.character(aus$Quarter), split = \" \"), \"[[\", 1))\n\n#the quarter Q1, Q2, Q3 etc as \"quarter\"\naus$quarter = sapply(strsplit(as.character(aus$Quarter), split = \" \"), \"[[\", 2)\n\n#original variable was called \"Quarter\" which is confusing, rename it to be more descriptive\ncolnames(aus)[colnames(aus) == 'Quarter'] <- 'year_quarter'\n\n\naus %>% \n    pivot_longer(cols = -c(year_quarter,year, quarter), names_to = \"product\", values_to = \"quantity\") \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1,308 × 5\n   year_quarter  year quarter product     quantity\n          <qtr> <int> <chr>   <chr>          <dbl>\n 1      1956 Q1  1956 Q1      Beer             284\n 2      1956 Q1  1956 Q1      Tobacco         5225\n 3      1956 Q1  1956 Q1      Bricks           189\n 4      1956 Q1  1956 Q1      Cement           465\n 5      1956 Q1  1956 Q1      Electricity     3923\n 6      1956 Q1  1956 Q1      Gas                5\n 7      1956 Q2  1956 Q2      Beer             213\n 8      1956 Q2  1956 Q2      Tobacco         5178\n 9      1956 Q2  1956 Q2      Bricks           204\n10      1956 Q2  1956 Q2      Cement           532\n# ℹ 1,298 more rows\n```\n\n\n:::\n:::\n\n\n### First look - Beer\n\nSay we have recently started tracking production of beer (in megaliters). We have just the past year's data, recorded by quarter:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeer_df <- select(aus, quarter, year, year_quarter, Beer)\n\nbeer_df[1:4, ] %>% \n    ggplot(aes(x = year_quarter, y = Beer))+\n    geom_point(size = 3)+ geom_line()+\n    labs(y = \"Beer (megaliters)\", title = \"First year\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nGood so far. We see Q2 and Q3 are lowest, but we don't know if this is meaningful or if this pattern will hold in future years. We could set up a control chart with just this year. Typically we would want more values before calculating limits, but we can start with as few values as we want really. Just remember these limits aren't based on much data, and should be treated with a grain of salt, and revisited when we have more data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeer_df[1:4, ] %>% \n    ggplot(aes(x = year_quarter, y = Beer))+\n    geom_point(size = 3)+ geom_line()+\n    stat_QC(method = \"XmR\", auto.label = TRUE)+\n    labs(y = \"Beer (megaliters)\", \n         title = \"First year control chart - limits are wide\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nBased on the control chart, we predict future values will fall somewhere between 110.8 and 405.2. Let's add another year and see what happens.\n\nFirst, I'll add the next year using the limits calculated on just year 1 (1956).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeer_df[1:8, ] %>% \n    ggplot(aes(x = year_quarter, y = Beer))+\n    geom_point(size = 3)+ geom_line()+\n    #stat_QC(method = \"XmR\", auto.label = TRUE)+\n    geom_hline(yintercept = c(405.2,258, 110.8), color = c(\"red\", \"blue\", \"red\"))+\n    labs(y = \"Beer (megaliters)\", \n         title = \"First 2 years, limits calculated with year 1\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nIt does look like there might be a quarterly pattern already. We might want to start breaking out quarters and tracking them on their own. I'd like to see if production in each quarter is growing, declining, or staying the same.\n\nWith year 3 I'll start tracking by quarter in addition to all quarters together:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeer_df[1:12, ] %>% \n    ggplot(aes(x = year_quarter, y = Beer))+\n    geom_point(size = 3)+ geom_line()+\n    #stat_QC(method = \"XmR\", auto.label = TRUE)+\n    geom_hline(yintercept = c(405.2,258, 110.8), color = c(\"red\", \"blue\", \"red\"))+\n    labs(y = \"Beer (megaliters)\", \n         title = \"First 3 years, limits calculated with year 1\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n```{.r .cell-code}\nbeer_df[1:12, ] %>% \n    ggplot(aes(x = year_quarter, y = Beer))+\n    geom_point(size = 3)+ geom_line()+\n    stat_QC(method = \"XmR\", auto.label = TRUE)+\n    #geom_hline(yintercept = c(405.2,258, 110.8), color = c(\"red\", \"blue\", \"red\"))+\n    labs(y = \"Beer (megaliters)\", \n         title = \"First 3 years, limits calculated with years 1-3\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-2.png){width=672}\n:::\n:::\n\n\nRecalculating the limits with 3 years of data has narrowed them somewhat, but I want to point this out - they aren't very different than the limits calculated with only year 1 (4 data points!). It's ok to calculate early and revisit.\n\nThe quarterly differences are very clear now, let's look at each quarter:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeer_df[1:12, ] %>% \n    ggplot(aes(x = year_quarter, y = Beer))+\n    geom_point(size = 2)+\n    geom_line()+\n    stat_QC(method = \"XmR\", auto.label = FALSE)+\n    facet_wrap(~quarter, ncol = 4)+\n    labs(y = \"Beer (megaliters)\", \n         title = \"First 3 years, limits calculated by quarter, with years 1-3\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nThe limits are very wide (relatively) due to the small number of data points per quarter. However, they are all much narrower than when we looked at all quarters together, indicating that the differences between quarters were inflating the variation observed.\n\n### Tracking by quarters - years 1-5\n\nSuppose we want to see production go up over time, the chart will help us see if this is happening.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeer_df[1:20, ] %>% \n    ggplot(aes(x = year_quarter, y = Beer))+\n    geom_point(size = 2)+\n    geom_line()+\n    stat_QC(method = \"XmR\", auto.label = FALSE)+\n    facet_wrap(~quarter, ncol = 4)+\n    labs(y = \"Beer (megaliters)\", \n         title = \"First 5 years, limits calculated by quarter, with years 1-5\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#I'm just entering the limits by hand, it's quicker right now than doing with\n#code, though that's easy to do with ggQC\nlimits5df <- data.frame(quarter = c(\"Q1\", \"Q2\",\"Q3\",\"Q4\"),\n                        UL  = c(318, 243, 264, 329), \n                        avg = c(273, 226, 242, 313), \n                        LL  = c(228, 208, 220, 298)\n                        )\n```\n:::\n\n\nLimits for Q1 are still relatively wider than other quarters. I don't see an upward trend yet, maybe in Q2 and Q3? With SPC, we're not sure yet...I have seen many patterns like this in the real world that turned out to just be noise. \n\n### Tracking by quarters - years 1-10\n\nIf I made an animation of this, we could see it unfold point by point, I'll work on that another time. (Right now I'm holding myself to a deadline so here's another static plot - what do the first 10 years look like?)\n\nBefore we look at this, note that I'm locking the limits we calculated with years 1-5 data. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeer_df[1:40, ] %>% \n    ggplot(aes(x = year_quarter, y = Beer))+\n    geom_point(size = 2)+\n    geom_line()+\n    geom_hline(data = limits5df, aes(yintercept = UL), color = \"red\")+\n    geom_hline(data = limits5df, aes(yintercept = LL), color = \"red\")+\n    geom_hline(data = limits5df, aes(yintercept = avg), color = \"blue\")+\n    facet_wrap(~quarter, ncol = 4)+\n    labs(y = \"Beer (megaliters)\", \n         title = \"First 10 years, limits calculated by quarter with years 1-5\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nA few interesting things (what do you see?):\nSeems like definite upward trends. \n\nBut when might we start to conclude that?\n\nQ2 and Q3 both have a point above the upper limit in year 7, Q4 exceeds the upper limit in year 6. Any point outside a limit indicates something unusual. After these years, the points continue to rise, at year 7 or 8 I would believe there really is an upward trend and start tracking differently.\n\n### Reflection\n\nSometimes there might be a tendency to overreact to data points, control charts are great for putting data in context. While it might look like there is an upward trend in some quarters, we got better confirmation of a change around year 6/7. Around year 8 I would switch to a trended control chart, fitting a regression line and putting limits around it to continue monitoring beer production.\n\n\n### Next Steps\n\nI'll put together trended control charts, and discuss the interpretation and calculations used.\n\n\n\n![](profile.jpg)\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}